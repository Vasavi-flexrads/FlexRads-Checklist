<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexRads Checklist</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom cherry-red color palette */
        :root {
            --flexrads-red: #E74C3C; /* A brighter, more vibrant red */
            --flexrads-dark-red: #C0392B; /* Darker red for hover states */
            --dark-background: #1A1A1A; /* Slightly lighter dark for main background */
            --content-background: #282828; /* Darker gray for content sections */
            --text-color: #ECF0F1; /* Off-white for general text */
            --border-color: #444444; /* Medium gray for borders */
            --input-background: #333333; /* Dark gray for input fields */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-background);
            color: var(--text-color);
        }

        /* Styling for the main container */
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--content-background);
            border-radius: 1rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6); /* More prominent shadow */
            position: relative; /* Needed for absolute positioning of logo */
        }

        /* Headings */
        h1, h2, h3 {
            color: var(--flexrads-red); /* Use the vibrant red for headings */
            font-weight: bold;
            margin-bottom: 1rem;
        }

        /* Labels for form elements */
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        /* Input fields and textareas */
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--input-background);
            color: var(--text-color);
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--flexrads-red); /* Vibrant red on focus */
        }

        /* Radio and checkbox styling */
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .radio-option:hover, .checkbox-option:hover {
            background-color: #3A3A3A; /* Slightly lighter dark gray on hover */
            border-color: var(--flexrads-red); /* Vibrant red on hover */
        }

        .radio-option input[type="radio"],
        .checkbox-option input[type="checkbox"] {
            margin-right: 0.5rem;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #666;
            border-radius: 50%; /* For radio buttons */
            background-color: #333;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
        }

        .checkbox-option input[type="checkbox"] {
            border-radius: 0.25rem; /* For checkboxes */
        }

        .radio-option input[type="radio"]:checked,
        .checkbox-option input[type="checkbox"]:checked {
            background-color: var(--flexrads-red); /* Vibrant red when checked */
            border-color: var(--flexrads-red);
        }

        /* Inner circle for checked radio button */
        .radio-option input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 0.6rem;
            height: 0.6rem;
            background-color: #fff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Checkmark for checked checkbox */
        .checkbox-option input[type="checkbox"]:checked::after {
            content: '\2713'; /* Checkmark character */
            display: block;
            color: #fff;
            font-size: 0.8rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Button styling */
        .action-button { /* General class for action buttons */
            background-color: var(--flexrads-red);
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            border: none;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6); /* Even more prominent shadow */
            display: inline-block; /* Ensure it respects margin/padding */
        }

        .action-button:hover {
            background-color: var(--flexrads-dark-red);
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }

        /* Report output area */
        #reportOutput {
            min-height: 200px;
            background-color: var(--input-background);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word; /* Break long words */
            font-family: monospace;
            color: var(--text-color);
        }

        /* Hidden class */
        .hidden {
            display: none;
        }

        /* Copy button styling (specific for the icon button) */
        .copy-btn {
            background: none;
            border: none;
            color: var(--flexrads-red);
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 0.5rem;
            padding: 0.2rem;
            border-radius: 0.3rem;
            transition: background-color 0.2s, color 0.2s;
            box-shadow: none; /* Override general button shadow */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .copy-btn:hover {
            background-color: rgba(231, 76, 60, 0.2); /* Light red hover */
            color: var(--flexrads-red);
            transform: none; /* Override general button lift */
            box-shadow: none; /* Override general button shadow */
        }

        .copy-btn:active {
            background-color: rgba(231, 76, 60, 0.4);
            transform: none;
            box-shadow: none;
        }

        /* Copy confirmation message */
        .copy-message {
            margin-left: 1rem;
            color: #27AE60; /* Green color for success */
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .copy-message.show {
            opacity: 1;
        }

        /* Section for individual knee/shoulder/hip checklists */
        .side-section { /* Renamed for generality */
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            background-color: #222222; /* Slightly different background for sub-sections */
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--content-background);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.8);
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
        }

        .modal-close-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 0.25rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .modal-close-btn:hover {
            background-color: #3A3A3A;
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-3xl text-center mb-6">FlexRads Checklist</h1>

        <!-- Modality and Study Selection -->
        <div class="mb-6 p-4 border border-gray-700 rounded-lg">
            <h2 class="text-xl mb-4">Study Selection</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="modalitySelect" class="block">Select Modality:</label>
                    <select id="modalitySelect" class="w-full">
                        <option value="">-- Please Select --</option>
                        <option value="X-Ray">X-Ray</option>
                        <option value="CT">CT</option>
                        <option value="MRI">MRI</option>
                        <option value="Ultrasound">Ultrasound</option>
                    </select>
                </div>
                <div>
                    <label for="studyTypeSelect" class="block">Select Study Type:</label>
                    <select id="studyTypeSelect" class="w-full" disabled>
                        <option value="">-- Please Select --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Dynamic Study Checklist Section (Main container for laterality and specific study) -->
        <div id="studyChecklistSection" class="hidden p-4 border border-gray-700 rounded-lg">
            <h2 id="studyChecklistTitle" class="text-xl mb-4"></h2> <!-- Title will be dynamic -->

            <!-- Clinical History -->
            <div class="mb-4">
                <label for="clinicalHistory" class="block">Clinical History:</label>
                <textarea id="clinicalHistory" rows="3" placeholder="Enter clinical history..."></textarea>
            </div>

            <!-- Laterality -->
            <div class="mb-4">
                <label class="block">Laterality:</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="laterality" value="Right"> Right
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="laterality" value="Left"> Left
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="laterality" value="Bilateral"> Bilateral
                    </label>
                </div>
            </div>

            <div id="dynamicSideChecklists">
                <!-- Dynamic knee/shoulder/hip checklists will be inserted here by JavaScript -->
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center gap-4 mt-6">
                <button id="generateReportBtn" class="action-button">Generate Report</button>
                <button id="clearFormBtn" class="action-button">Clear Form</button>
            </div>
        </div>

        <!-- Report Output Area -->
        <div class="mt-8 p-4 border border-gray-700 rounded-lg">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl">Report Transcript</h2>
                <div class="flex items-center">
                    <button id="copyReportBtn" class="copy-btn" title="Copy to Clipboard">
                        <!-- Clipboard icon (SVG for better styling and control) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                    <span id="copyMessage" class="copy-message">Copied!</span>
                </div>
            </div>
            <textarea id="reportOutput" readonly class="w-full"></textarea>
        </div>
    </div>

    <!-- Dislocation/Subluxation Warning Modal -->
    <div id="dislocationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="document.getElementById('dislocationModal').classList.add('hidden');">&times;</button>
            <h3 class="text-xl text-red-500 mb-4">Warning!</h3>
            <p class="text-lg">Flag this to the reporting radiologist for suspected dislocation/sublaxation.</p>
            <button class="action-button mt-6" onclick="document.getElementById('dislocationModal').classList.add('hidden');">Acknowledge</button>
        </div>
    </div>

    <script>
        // DOM element references
        const modalitySelect = document.getElementById('modalitySelect');
        const studyTypeSelect = document.getElementById('studyTypeSelect');
        const studyChecklistSection = document.getElementById('studyChecklistSection');
        const studyChecklistTitle = document.getElementById('studyChecklistTitle');
        const lateralityRadios = document.querySelectorAll('input[name="laterality"]');
        const dynamicSideChecklistsContainer = document.getElementById('dynamicSideChecklists');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const reportOutput = document.getElementById('reportOutput');
        const copyReportBtn = document.getElementById('copyReportBtn');
        const copyMessage = document.getElementById('copyMessage');
        const clinicalHistoryTextarea = document.getElementById('clinicalHistory');
        const dislocationModal = document.getElementById('dislocationModal'); // Modal element

        // Global variable to store the currently selected study type
        let currentStudyType = '';

        // Helper function to update visibility of conditional fields
        function updateConditionalVisibility(radioGroup, targetElement) {
            radioGroup.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'Yes' || radio.value === 'Present' || radio.value === 'Abnormal') {
                        targetElement.classList.remove('hidden');
                    } else {
                        targetElement.classList.add('hidden');
                        // Reset inputs within hidden sections to avoid stale data
                        targetElement.querySelectorAll('input[type="text"], input[type="checkbox"], input[type="radio"]').forEach(input => {
                            if (input.type === 'text') input.value = '';
                            if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                        });
                        // For radio groups, ensure a default 'No' or 'Absent' is selected if available
                        const defaultRadio = targetElement.querySelector('input[value="No"], input[value="Absent"], input[value="None"], input[value="Normal"]');
                        if (defaultRadio) defaultRadio.checked = true;
                    }
                });
            });
        }

        /**
         * Creates and returns a DOM element for a single Knee checklist section.
         * @param {string} prefix - A unique prefix for input names and IDs (e.g., 'right_', 'left_').
         * @param {string} sideName - The display name for this side (e.g., 'Right Knee', 'Left Knee').
         * @param {string} selectedLaterality - The overall laterality selected ('Right', 'Left', 'Bilateral').
         * @returns {HTMLElement} The created div element containing the checklist.
         */
        function createKneeChecklistElements(prefix, sideName, selectedLaterality) {
            const sectionDiv = document.createElement('div');
            sectionDiv.id = `${prefix}KneeSection`;
            sectionDiv.className = 'side-section mt-6';

            const h3Title = (selectedLaterality === 'Bilateral') ? `${sideName} Checklist Items:` : `Checklist Items:`;

            sectionDiv.innerHTML = `
                <h3 class="text-xl mb-4">${h3Title}</h3>

                <!-- 1. Degenerative Changes -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">1. Degenerative changes:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}degenerativeChanges" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}degenerativeChanges" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}degenerativeDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <label class="block mb-2">Compartments (multi-select):</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}compartments" value="Medial" data-severity-target="${prefix}medialSeverityDetails"> Medial
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}compartments" value="Lateral" data-severity-target="${prefix}lateralSeverityDetails"> Lateral
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}compartments" value="Patellofemoral" data-severity-target="${prefix}patellofemoralSeverityDetails"> Patellofemoral
                            </label>
                        </div>

                        <div id="${prefix}medialSeverityDetails" class="hidden mt-2">
                            <label class="block mb-2">Medial Compartment Severity:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}medialSeverity" value="Mild"> Mild
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}medialSeverity" value="Moderate"> Moderate
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}medialSeverity" value="Severe"> Severe
                                </label>
                            </div>
                        </div>

                        <div id="${prefix}lateralSeverityDetails" class="hidden mt-2">
                            <label class="block mb-2">Lateral Compartment Severity:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}lateralSeverity" value="Mild"> Mild
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}lateralSeverity" value="Moderate"> Moderate
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}lateralSeverity" value="Severe"> Severe
                                </label>
                            </div>
                        </div>

                        <div id="${prefix}patellofemoralSeverityDetails" class="hidden mt-2">
                            <label class="block mb-2">Patellofemoral Compartment Severity:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}patellofemoralSeverity" value="Mild"> Mild
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}patellofemoralSeverity" value="Moderate"> Moderate
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}patellofemoralSeverity" value="Severe"> Severe
                                </label>
                            </div>
                        </div>

                        <label class="block mb-2">Osteophyte:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}osteophyte" value="Present"> Present
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}osteophyte" value="Absent" checked> Absent
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 2. Fracture -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">2. Fracture:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}fracture" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}fracture" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}fractureDetails" class="hidden mt-2">
                        <label for="${prefix}fractureTypeLocation" class="block">Type and Location:</label>
                        <input type="text" id="${prefix}fractureTypeLocation" placeholder="e.g., Tibial plateau fracture, non-displaced">
                    </div>
                </div>

                <!-- 3. Joint Effusion -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">3. Joint effusion:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}jointEffusion" value="None" checked> None
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}jointEffusion" value="Mild"> Mild
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}jointEffusion" value="Moderate"> Moderate
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}jointEffusion" value="Severe"> Severe
                        </label>
                    </div>
                </div>

                <!-- 4. Vascular Calcification -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">4. Vascular calcification:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}vascularCalcification" value="Present"> Present
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}vascularCalcification" value="Absent" checked> Absent
                        </label>
                    </div>
                </div>

                <!-- 5. Any Implants -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">5. Any Implants:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}implants" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}implants" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}implantsDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}implantType" value="TKR"> TKR (Total Knee Replacement)
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}implantType" value="Partial knee replacement"> Partial knee replacement
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}implantType" value="Others"> Others
                            </label>
                        </div>
                        <div id="${prefix}partialKneeDetails" class="hidden mt-2">
                            <label for="${prefix}partialKneeCompartment" class="block">Compartment:</label>
                            <input type="text" id="${prefix}partialKneeCompartment" placeholder="e.g., Medial">
                        </div>
                        <div id="${prefix}otherImplantsDetails" class="hidden mt-2">
                            <label for="${prefix}otherImplantType" class="block">Specify Other:</label>
                            <input type="text" id="${prefix}otherImplantType" placeholder="e.g., Screws, plates">
                        </div>
                    </div>
                </div>

                <!-- 6. Lesion -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">6. Lesion:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}lesion" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}lesion" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}lesionDetails" class="hidden mt-2">
                        <label for="${prefix}lesionRegion" class="block">Region:</label>
                        <input type="text" id="${prefix}lesionRegion" placeholder="e.g., Distal femur">
                        <label for="${prefix}lesionSize" class="block">Size:</label>
                        <input type="text" id="${prefix}lesionSize" placeholder="e.g., 2x3 cm">
                    </div>
                </div>

                <!-- 7. Post op -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">7. Post op:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}postOpStatus" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}postOpStatus" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}postOpDetails" class="hidden mt-2">
                        <label for="${prefix}postOpDescription" class="block">Description:</label>
                        <input type="text" id="${prefix}postOpDescription" placeholder="e.g., Status post ACL reconstruction">
                    </div>
                </div>
            `;

            // Attach event listeners for the dynamically created elements
            // This needs to be done AFTER the HTML is inserted into the DOM
            setTimeout(() => {
                const degenerativeChangesRadios = sectionDiv.querySelectorAll(`input[name="${prefix}degenerativeChanges"]`);
                const degenerativeDetails = sectionDiv.querySelector(`#${prefix}degenerativeDetails`);
                updateConditionalVisibility(degenerativeChangesRadios, degenerativeDetails);

                const compartmentCheckboxes = sectionDiv.querySelectorAll(`input[name="${prefix}compartments"]`);
                compartmentCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const targetId = checkbox.dataset.severityTarget;
                        const targetElement = sectionDiv.querySelector(`#${targetId}`);
                        if (targetElement) {
                            if (checkbox.checked) {
                                targetElement.classList.remove('hidden');
                                const defaultSeverityRadio = targetElement.querySelector('input[type="radio"]');
                                if (defaultSeverityRadio && !targetElement.querySelector('input[type="radio"]:checked')) {
                                    defaultSeverityRadio.checked = true;
                                }
                            } else {
                                targetElement.classList.add('hidden');
                                targetElement.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                            }
                        }
                    });
                });

                const fractureRadios = sectionDiv.querySelectorAll(`input[name="${prefix}fracture"]`);
                const fractureDetails = sectionDiv.querySelector(`#${prefix}fractureDetails`);
                updateConditionalVisibility(fractureRadios, fractureDetails);

                const implantsRadios = sectionDiv.querySelectorAll(`input[name="${prefix}implants"]`);
                const implantsDetails = sectionDiv.querySelector(`#${prefix}implantsDetails`);
                updateConditionalVisibility(implantsRadios, implantsDetails);

                const implantTypeRadios = sectionDiv.querySelectorAll(`input[name="${prefix}implantType"]`);
                const partialKneeDetails = sectionDiv.querySelector(`#${prefix}partialKneeDetails`);
                const otherImplantsDetails = sectionDiv.querySelector(`#${prefix}otherImplantsDetails`);
                implantTypeRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        if (partialKneeDetails) partialKneeDetails.classList.add('hidden');
                        if (otherImplantsDetails) otherImplantsDetails.classList.add('hidden');
                        const partialKneeCompartmentInput = sectionDiv.querySelector(`#${prefix}partialKneeCompartment`);
                        if (partialKneeCompartmentInput) partialKneeCompartmentInput.value = '';
                        const otherImplantTypeInput = sectionDiv.querySelector(`#${prefix}otherImplantType`);
                        if (otherImplantTypeInput) otherImplantTypeInput.value = '';

                        if (radio.value === 'Partial knee replacement') {
                            if (partialKneeDetails) partialKneeDetails.classList.remove('hidden');
                        } else if (radio.value === 'Others') {
                            if (otherImplantsDetails) otherImplantsDetails.classList.remove('hidden');
                        }
                    });
                });

                const lesionRadios = sectionDiv.querySelectorAll(`input[name="${prefix}lesion"]`);
                const lesionDetails = sectionDiv.querySelector(`#${prefix}lesionDetails`);
                updateConditionalVisibility(lesionRadios, lesionDetails);

                const postOpStatusRadios = sectionDiv.querySelectorAll(`input[name="${prefix}postOpStatus"]`);
                const postOpDetails = sectionDiv.querySelector(`#${prefix}postOpDetails`);
                updateConditionalVisibility(postOpStatusRadios, postOpDetails);

                // Ensure initial default states for dynamically created elements
                const degNoRadio = sectionDiv.querySelector(`input[name="${prefix}degenerativeChanges"][value="No"]`);
                if (degNoRadio) degNoRadio.checked = true;
                const fractureNoRadio = sectionDiv.querySelector(`input[name="${prefix}fracture"][value="No"]`);
                if (fractureNoRadio) fractureNoRadio.checked = true;
                const jointEffusionNoneRadio = sectionDiv.querySelector(`input[name="${prefix}jointEffusion"][value="None"]`);
                if (jointEffusionNoneRadio) jointEffusionNoneRadio.checked = true;
                const vascularCalcificationAbsentRadio = sectionDiv.querySelector(`input[name="${prefix}vascularCalcification"][value="Absent"]`);
                if (vascularCalcificationAbsentRadio) vascularCalcificationAbsentRadio.checked = true;
                const implantsNoRadio = sectionDiv.querySelector(`input[name="${prefix}implants"][value="No"]`);
                if (implantsNoRadio) implantsNoRadio.checked = true;
                const lesionNoRadio = sectionDiv.querySelector(`input[name="${prefix}lesion"][value="No"]`);
                if (lesionNoRadio) lesionNoRadio.checked = true;
                const postOpStatusNoRadio = sectionDiv.querySelector(`input[name="${prefix}postOpStatus"][value="No"]`);
                if (postOpStatusNoRadio) postOpStatusNoRadio.checked = true;

            }, 0);

            return sectionDiv;
        }

        /**
         * Creates and returns a DOM element for a single Shoulder checklist section.
         * @param {string} prefix - A unique prefix for input names and IDs (e.g., 'right_', 'left_').
         * @param {string} sideName - The display name for this side (e.g., 'Right Shoulder', 'Left Shoulder').
         * @param {string} selectedLaterality - The overall laterality selected ('Right', 'Left', 'Bilateral').
         * @returns {HTMLElement} The created div element containing the checklist.
         */
        function createShoulderChecklistElements(prefix, sideName, selectedLaterality) {
            const sectionDiv = document.createElement('div');
            sectionDiv.id = `${prefix}ShoulderSection`;
            sectionDiv.className = 'side-section mt-6';

            const h3Title = (selectedLaterality === 'Bilateral') ? `${sideName} Checklist Items:` : `Checklist Items:`;

            sectionDiv.innerHTML = `
                <h3 class="text-xl mb-4">${h3Title}</h3>

                <!-- 1. Hardware -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">1. Hardware:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hardware" value="Present"> Present
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hardware" value="Absent" checked> Absent
                        </label>
                    </div>
                    <div id="${prefix}hardwareDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hardwareType" value="Reversed shoulder arthroplasty"> Reversed shoulder arthroplasty
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hardwareType" value="Plate and screw fixation"> Plate and screw fixation
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hardwareType" value="Rotator cuff repair"> Rotator cuff repair
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hardwareType" value="Others"> Others
                            </label>
                        </div>
                        <div id="${prefix}otherHardwareDetails" class="hidden mt-2">
                            <label for="${prefix}otherHardwareType" class="block">Specify Other Hardware:</label>
                            <input type="text" id="${prefix}otherHardwareType" placeholder="e.g., Suture anchors, wires">
                        </div>
                    </div>
                </div>

                <!-- 2. Post surgical changes / acute soft tissue changes -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">2. Post surgical changes / acute soft tissue changes:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}postSurgicalAcuteSoftTissue" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}postSurgicalAcuteSoftTissue" value="No" checked> No
                        </label>
                    </div>
                </div>

                <!-- 3. Degenerative changes -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">3. Degenerative changes:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}shoulderDegenerativeChanges" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}shoulderDegenerativeChanges" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}shoulderDegenerativeDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <label class="block mb-2">Compartments (multi-select):</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}shoulderDegCompartments" value="Glenohumeral" data-severity-target="${prefix}ghDegSeverityDetails"> Glenohumeral
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}shoulderDegCompartments" value="Acromioclavicular" data-severity-target="${prefix}acDegSeverityDetails"> AC
                            </label>
                        </div>
                        <div id="${prefix}ghDegSeverityDetails" class="hidden mt-2">
                            <label class="block mb-2">Glenohumeral Severity:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}ghDegSeverity" value="Mild"> Mild
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}ghDegSeverity" value="Moderate"> Moderate
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}ghDegSeverity" value="Severe"> Severe
                                </label>
                            </div>
                        </div>
                        <div id="${prefix}acDegSeverityDetails" class="hidden mt-2">
                            <label class="block mb-2">AC Severity:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}acDegSeverity" value="Mild"> Mild
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}acDegSeverity" value="Moderate"> Moderate
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}acDegSeverity" value="Severe"> Severe
                                </label>
                            </div>
                        </div>
                        <label class="block mb-2">Osteophytes:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}shoulderOsteophyte" value="Yes"> Yes
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}shoulderOsteophyte" value="No" checked> No
                            </label>
                        </div>
                        <label class="block mt-4 mb-2">Joint space narrowing:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}shoulderJointSpaceNarrowing" value="Yes"> Yes
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}shoulderJointSpaceNarrowing" value="No" checked> No
                            </label>
                        </div>
                        <div id="${prefix}shoulderNarrowingDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                            <label class="block mb-2">Joints (multi-select):</label>
                            <div class="checkbox-group">
                                <label class="checkbox-option">
                                    <input type="checkbox" name="${prefix}shoulderNarrowingJoints" value="Glenohumeral joint"> Glenohumeral joint
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" name="${prefix}shoulderNarrowingJoints" value="AC joint"> AC joint
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. Fracture followup -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">4. Fracture followup:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}fractureFollowup" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}fractureFollowup" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}fractureFollowupDetails" class="hidden mt-2">
                        <label for="${prefix}oldHealedFractureRegion" class="block">Old healed fracture, region:</label>
                        <input type="text" id="${prefix}oldHealedFractureRegion" placeholder="e.g., Proximal humerus">
                        <label for="${prefix}healingFractureRegion" class="block">Healing fracture, region:</label>
                        <input type="text" id="${prefix}healingFractureRegion" placeholder="e.g., Clavicle midshaft">
                    </div>
                </div>

                <!-- 5. Acute fracture -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">5. Acute fracture:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}acuteFracture" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}acuteFracture" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}acuteFractureDetails" class="hidden mt-2">
                        <label for="${prefix}acuteFractureType" class="block">Type:</label>
                        <input type="text" id="${prefix}acuteFractureType" placeholder="e.g., Non-displaced, comminuted">
                        <label for="${prefix}acuteFractureRegion" class="block">Region:</label>
                        <input type="text" id="${prefix}acuteFractureRegion" placeholder="e.g., Humeral head">
                    </div>
                </div>

                <!-- 6. Rotator cuff calcification -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">6. Rotator cuff calcification:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}rotatorCuffCalcification" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}rotatorCuffCalcification" value="No" checked> No
                        </label>
                    </div>
                </div>

                <!-- 7. Lesion -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">7. Lesion:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}lesion" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}lesion" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}lesionDetails" class="hidden mt-2">
                        <label for="${prefix}lesionRegion" class="block">Region:</label>
                        <input type="text" id="${prefix}lesionRegion" placeholder="e.g., Humeral head">
                        <label for="${prefix}lesionSize" class="block">Size:</label>
                        <input type="text" id="${prefix}lesionSize" placeholder="e.g., 1.5 x 2 cm">
                        <label for="${prefix}lesionCharacteristics" class="block">Characteristics:</label>
                        <input type="text" id="${prefix}lesionCharacteristics" placeholder="e.g., Sclerotic, lytic">
                    </div>
                </div>

                <!-- 8. Dislocation/ sublaxation -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">8. Dislocation/ sublaxation:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}dislocationSubluxation" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}dislocationSubluxation" value="No" checked> No
                        </label>
                    </div>
                </div>
            `;

            // Attach event listeners for the dynamically created elements
            setTimeout(() => {
                // Hardware
                const hardwareRadios = sectionDiv.querySelectorAll(`input[name="${prefix}hardware"]`);
                const hardwareDetails = sectionDiv.querySelector(`#${prefix}hardwareDetails`);
                updateConditionalVisibility(hardwareRadios, hardwareDetails);

                const hardwareTypeRadios = sectionDiv.querySelectorAll(`input[name="${prefix}hardwareType"]`);
                const otherHardwareDetails = sectionDiv.querySelector(`#${prefix}otherHardwareDetails`);
                hardwareTypeRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        if (otherHardwareDetails) otherHardwareDetails.classList.add('hidden');
                        const otherHardwareTypeInput = sectionDiv.querySelector(`#${prefix}otherHardwareType`);
                        if (otherHardwareTypeInput) otherHardwareTypeInput.value = '';

                        if (radio.value === 'Others') {
                            if (otherHardwareDetails) otherHardwareDetails.classList.remove('hidden');
                        }
                    });
                });

                // Degenerative Changes
                const shoulderDegenerativeChangesRadios = sectionDiv.querySelectorAll(`input[name="${prefix}shoulderDegenerativeChanges"]`);
                const shoulderDegenerativeDetails = sectionDiv.querySelector(`#${prefix}shoulderDegenerativeDetails`);
                updateConditionalVisibility(shoulderDegenerativeChangesRadios, shoulderDegenerativeDetails);

                const shoulderDegCompartmentCheckboxes = sectionDiv.querySelectorAll(`input[name="${prefix}shoulderDegCompartments"]`);
                shoulderDegCompartmentCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const targetId = checkbox.dataset.severityTarget;
                        const targetElement = sectionDiv.querySelector(`#${targetId}`);
                        if (targetElement) {
                            if (checkbox.checked) {
                                targetElement.classList.remove('hidden');
                                const defaultSeverityRadio = targetElement.querySelector('input[type="radio"]');
                                if (defaultSeverityRadio && !targetElement.querySelector('input[type="radio"]:checked')) {
                                    defaultSeverityRadio.checked = true;
                                }
                            } else {
                                targetElement.classList.add('hidden');
                                targetElement.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                            }
                        }
                    });
                });

                const shoulderJointSpaceNarrowingRadios = sectionDiv.querySelectorAll(`input[name="${prefix}shoulderJointSpaceNarrowing"]`);
                const shoulderNarrowingDetails = sectionDiv.querySelector(`#${prefix}shoulderNarrowingDetails`);
                updateConditionalVisibility(shoulderJointSpaceNarrowingRadios, shoulderNarrowingDetails);


                // Fracture followup
                const fractureFollowupRadios = sectionDiv.querySelectorAll(`input[name="${prefix}fractureFollowup"]`);
                const fractureFollowupDetails = sectionDiv.querySelector(`#${prefix}fractureFollowupDetails`);
                updateConditionalVisibility(fractureFollowupRadios, fractureFollowupDetails);

                // Acute fracture
                const acuteFractureRadios = sectionDiv.querySelectorAll(`input[name="${prefix}acuteFracture"]`);
                const acuteFractureDetails = sectionDiv.querySelector(`#${prefix}acuteFractureDetails`);
                updateConditionalVisibility(acuteFractureRadios, acuteFractureDetails);

                // Lesion
                const lesionRadios = sectionDiv.querySelectorAll(`input[name="${prefix}lesion"]`);
                const lesionDetails = sectionDiv.querySelector(`#${prefix}lesionDetails`);
                updateConditionalVisibility(lesionRadios, lesionDetails);

                // Ensure initial default states for dynamically created elements
                const hardwareAbsentRadio = sectionDiv.querySelector(`input[name="${prefix}hardware"][value="Absent"]`);
                if (hardwareAbsentRadio) hardwareAbsentRadio.checked = true;
                const postSurgicalNoRadio = sectionDiv.querySelector(`input[name="${prefix}postSurgicalAcuteSoftTissue"][value="No"]`);
                if (postSurgicalNoRadio) postSurgicalNoRadio.checked = true;
                const degNoRadio = sectionDiv.querySelector(`input[name="${prefix}shoulderDegenerativeChanges"][value="No"]`);
                if (degNoRadio) degNoRadio.checked = true;
                const shoulderOsteophyteNoRadio = sectionDiv.querySelector(`input[name="${prefix}shoulderOsteophyte"][value="No"]`);
                if (shoulderOsteophyteNoRadio) shoulderOsteophyteNoRadio.checked = true;
                const shoulderJointSpaceNarrowingNoRadio = sectionDiv.querySelector(`input[name="${prefix}shoulderJointSpaceNarrowing"][value="No"]`);
                if (shoulderJointSpaceNarrowingNoRadio) shoulderJointSpaceNarrowingNoRadio.checked = true;
                const fractureFollowupNoRadio = sectionDiv.querySelector(`input[name="${prefix}fractureFollowup"][value="No"]`);
                if (fractureFollowupNoRadio) fractureFollowupNoRadio.checked = true;
                const acuteFractureNoRadio = sectionDiv.querySelector(`input[name="${prefix}acuteFracture"][value="No"]`);
                if (acuteFractureNoRadio) acuteFractureNoRadio.checked = true;
                const rotatorCuffCalcificationNoRadio = sectionDiv.querySelector(`input[name="${prefix}rotatorCuffCalcification"][value="No"]`);
                if (rotatorCuffCalcificationNoRadio) rotatorCuffCalcificationNoRadio.checked = true;
                const lesionNoRadio = sectionDiv.querySelector(`input[name="${prefix}lesion"][value="No"]`);
                if (lesionNoRadio) lesionNoRadio.checked = true;
                const dislocationSubluxationNoRadio = sectionDiv.querySelector(`input[name="${prefix}dislocationSubluxation"][value="No"]`);
                if (dislocationSubluxationNoRadio) dislocationSubluxationNoRadio.checked = true;

            }, 0);

            return sectionDiv;
        }

        /**
         * Creates and returns a DOM element for a single Hip checklist section.
         * @param {string} prefix - A unique prefix for input names and IDs (e.g., 'right_', 'left_').
         * @param {string} sideName - The display name for this side (e.g., 'Right Hip', 'Left Hip').
         * @param {string} selectedLaterality - The overall laterality selected ('Right', 'Left', 'Bilateral').
         * @returns {HTMLElement} The created div element containing the checklist.
         */
        function createHipChecklistElements(prefix, sideName, selectedLaterality) {
            const sectionDiv = document.createElement('div');
            sectionDiv.id = `${prefix}HipSection`;
            sectionDiv.className = 'side-section mt-6';

            const h3Title = (selectedLaterality === 'Bilateral') ? `${sideName} Checklist Items:` : `Checklist Items:`;

            sectionDiv.innerHTML = `
                <h3 class="text-xl mb-4">${h3Title}</h3>

                <!-- 1. Hardware -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">1. Hardware:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipHardware" value="Present"> Present
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipHardware" value="Absent" checked> Absent
                        </label>
                    </div>
                    <div id="${prefix}hipHardwareDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipHardwareType" value="Total arthroplasty"> Total arthroplasty
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipHardwareType" value="Hemi arthroplasty"> Hemi arthroplasty
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipHardwareType" value="Intermedullary screw and nail fixation"> Intermedullary screw and nail fixation
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipHardwareType" value="Copper T IUD"> Copper T IUD
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipHardwareType" value="Others"> Others
                            </label>
                        </div>
                        <div id="${prefix}hipOtherHardwareDetails" class="hidden mt-2">
                            <label for="${prefix}hipOtherHardwareType" class="block">Specify Other Hardware:</label>
                            <input type="text" id="${prefix}hipOtherHardwareType" placeholder="e.g., Screws, plates">
                        </div>
                    </div>
                </div>

                <!-- 2. Degenerative changes -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">2. Degenerative changes:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipDegenerativeChanges" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipDegenerativeChanges" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}hipDegenerativeDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <label class="block mb-2">Severity:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipDegSeverity" value="Mild"> Mild
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipDegSeverity" value="Moderate"> Moderate
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipDegSeverity" value="Severe"> Severe
                            </label>
                        </div>
                        <label class="block mt-4 mb-2">Joint space narrowing:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipJointSpaceNarrowing" value="Yes"> Yes
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipJointSpaceNarrowing" value="No" checked> No
                            </label>
                        </div>
                        <label class="block mt-4 mb-2">Osteophytes:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipOsteophytes" value="Yes"> Yes
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipOsteophytes" value="No" checked> No
                            </label>
                        </div>
                        <label class="block mt-4 mb-2">Sclerotic changes:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipScleroticChanges" value="Yes"> Yes
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}hipScleroticChanges" value="No" checked> No
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 3. Heterotopic calcification -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">3. Heterotopic calcification:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}heterotopicCalcification" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}heterotopicCalcification" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}heterotopicCalcificationDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <label class="block mb-2">Region (multi-select):</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}heterotopicRegions" value="Acetabulum"> Acetabulum
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}heterotopicRegions" value="Greater trochanter region"> Greater trochanter region
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 4. Vascular calcification -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">4. Vascular calcification:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipVascularCalcification" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipVascularCalcification" value="No" checked> No
                        </label>
                    </div>
                </div>

                <!-- 5. Lesion -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">5. Lesion:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipLesion" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipLesion" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}hipLesionDetails" class="hidden mt-2">
                        <label for="${prefix}hipLesionRegion" class="block">Region:</label>
                        <input type="text" id="${prefix}hipLesionRegion" placeholder="e.g., Femoral head">
                        <label for="${prefix}hipLesionSize" class="block">Size:</label>
                        <input type="text" id="${prefix}hipLesionSize" placeholder="e.g., 3 x 4 cm">
                        <label for="${prefix}hipLesionCharacteristics" class="block">Characteristics:</label>
                        <input type="text" id="${prefix}hipLesionCharacteristics" placeholder="e.g., Sclerotic, lytic, mixed">
                    </div>
                </div>

                <!-- 6. Fracture -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">6. Fracture:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipFracture" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipFracture" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}hipFractureDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <label class="block mb-2">Regions (multi-select):</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}hipFractureRegions" value="Femoral head" data-fracture-type-target="${prefix}femoralHeadFractureTypeDetails"> Femoral head
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}hipFractureRegions" value="Acetabulum" data-fracture-type-target="${prefix}acetabulumFractureTypeDetails"> Acetabulum
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}hipFractureRegions" value="Superior pubic ramus" data-fracture-type-target="${prefix}sprFractureTypeDetails"> Superior pubic ramus
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}hipFractureRegions" value="Inferior pubic ramus" data-fracture-type-target="${prefix}iprFractureTypeDetails"> Inferior pubic ramus
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}hipFractureRegions" value="Femoral neck" data-fracture-type-target="${prefix}femoralNeckFractureTypeDetails"> Femoral neck
                            </label>
                        </div>
                        <!-- Dynamic fracture type inputs for each region -->
                        <div id="${prefix}femoralHeadFractureTypeDetails" class="hidden mt-2">
                            <label for="${prefix}femoralHeadFractureType" class="block">Femoral head fracture type:</label>
                            <input type="text" id="${prefix}femoralHeadFractureType" placeholder="e.g., Subcapital">
                        </div>
                        <div id="${prefix}acetabulumFractureTypeDetails" class="hidden mt-2">
                            <label for="${prefix}acetabulumFractureType" class="block">Acetabulum fracture type:</label>
                            <input type="text" id="${prefix}acetabulumFractureType" placeholder="e.g., Anterior column">
                        </div>
                        <div id="${prefix}sprFractureTypeDetails" class="hidden mt-2">
                            <label for="${prefix}sprFractureType" class="block">Superior pubic ramus fracture type:</label>
                            <input type="text" id="${prefix}sprFractureType" placeholder="e.g., Displaced">
                        </div>
                        <div id="${prefix}iprFractureTypeDetails" class="hidden mt-2">
                            <label for="${prefix}iprFractureType" class="block">Inferior pubic ramus fracture type:</label>
                            <input type="text" id="${prefix}iprFractureType" placeholder="e.g., Non-displaced">
                        </div>
                        <div id="${prefix}femoralNeckFractureTypeDetails" class="hidden mt-2">
                            <label for="${prefix}femoralNeckFractureType" class="block">Femoral neck fracture type:</label>
                            <input type="text" id="${prefix}femoralNeckFractureType" placeholder="e.g., Garden I">
                        </div>
                    </div>
                </div>

                <!-- 7. Dislocation/Subluxation -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">7. Dislocation/Subluxation:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipDislocationSubluxation" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}hipDislocationSubluxation" value="No" checked> No
                        </label>
                    </div>
                </div>
            `;

            // Attach event listeners for the dynamically created elements
            setTimeout(() => {
                // Hardware
                const hipHardwareRadios = sectionDiv.querySelectorAll(`input[name="${prefix}hipHardware"]`);
                const hipHardwareDetails = sectionDiv.querySelector(`#${prefix}hipHardwareDetails`);
                updateConditionalVisibility(hipHardwareRadios, hipHardwareDetails);

                const hipHardwareTypeRadios = sectionDiv.querySelectorAll(`input[name="${prefix}hipHardwareType"]`);
                const hipOtherHardwareDetails = sectionDiv.querySelector(`#${prefix}hipOtherHardwareDetails`);
                hipHardwareTypeRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        if (hipOtherHardwareDetails) hipOtherHardwareDetails.classList.add('hidden');
                        const hipOtherHardwareTypeInput = sectionDiv.querySelector(`#${prefix}hipOtherHardwareType`);
                        if (hipOtherHardwareTypeInput) hipOtherHardwareTypeInput.value = '';

                        if (radio.value === 'Others') {
                            if (hipOtherHardwareDetails) hipOtherHardwareDetails.classList.remove('hidden');
                        }
                    });
                });

                // Degenerative Changes
                const hipDegenerativeChangesRadios = sectionDiv.querySelectorAll(`input[name="${prefix}hipDegenerativeChanges"]`);
                const hipDegenerativeDetails = sectionDiv.querySelector(`#${prefix}hipDegenerativeDetails`);
                updateConditionalVisibility(hipDegenerativeChangesRadios, hipDegenerativeDetails);

                // Heterotopic Calcification
                const heterotopicCalcificationRadios = sectionDiv.querySelectorAll(`input[name="${prefix}heterotopicCalcification"]`);
                const heterotopicCalcificationDetails = sectionDiv.querySelector(`#${prefix}heterotopicCalcificationDetails`);
                updateConditionalVisibility(heterotopicCalcificationRadios, heterotopicCalcificationDetails);

                // Lesion
                const hipLesionRadios = sectionDiv.querySelectorAll(`input[name="${prefix}hipLesion"]`);
                const hipLesionDetails = sectionDiv.querySelector(`#${prefix}hipLesionDetails`);
                updateConditionalVisibility(hipLesionRadios, hipLesionDetails);

                // Fracture
                const hipFractureRadios = sectionDiv.querySelectorAll(`input[name="${prefix}hipFracture"]`);
                const hipFractureDetails = sectionDiv.querySelector(`#${prefix}hipFractureDetails`);
                updateConditionalVisibility(hipFractureRadios, hipFractureDetails);

                const hipFractureRegionsCheckboxes = sectionDiv.querySelectorAll(`input[name="${prefix}hipFractureRegions"]`);
                hipFractureRegionsCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const targetId = checkbox.dataset.fractureTypeTarget;
                        const targetElement = sectionDiv.querySelector(`#${targetId}`);
                        if (targetElement) {
                            if (checkbox.checked) {
                                targetElement.classList.remove('hidden');
                            } else {
                                targetElement.classList.add('hidden');
                                targetElement.querySelector('input[type="text"]').value = ''; // Clear input if unchecked
                            }
                        }
                    });
                });

                // Ensure initial default states for dynamically created elements
                const hipHardwareAbsentRadio = sectionDiv.querySelector(`input[name="${prefix}hipHardware"][value="Absent"]`);
                if (hipHardwareAbsentRadio) hipHardwareAbsentRadio.checked = true;
                const hipDegNoRadio = sectionDiv.querySelector(`input[name="${prefix}hipDegenerativeChanges"][value="No"]`);
                if (hipDegNoRadio) hipDegenerativeChangesRadios.checked = true;
                const hipJointSpaceNarrowingNoRadio = sectionDiv.querySelector(`input[name="${prefix}hipJointSpaceNarrowing"][value="No"]`);
                if (hipJointSpaceNarrowingNoRadio) hipJointSpaceNarrowingNoRadio.checked = true;
                const hipOsteophytesNoRadio = sectionDiv.querySelector(`input[name="${prefix}hipOsteophytes"][value="No"]`);
                if (hipOsteophytesNoRadio) hipOsteophytesNoRadio.checked = true;
                const hipScleroticChangesNoRadio = sectionDiv.querySelector(`input[name="${prefix}hipScleroticChanges"][value="No"]`);
                if (hipScleroticChangesNoRadio) hipScleroticChangesNoRadio.checked = true;
                const heterotopicCalcificationNoRadio = sectionDiv.querySelector(`input[name="${prefix}heterotopicCalcification"][value="No"]`);
                if (heterotopicCalcificationNoRadio) heterotopicCalcificationNoRadio.checked = true;
                const hipVascularCalcificationNoRadio = sectionDiv.querySelector(`input[name="${prefix}hipVascularCalcification"][value="No"]`);
                if (hipVascularCalcificationNoRadio) hipVascularCalcificationNoRadio.checked = true;
                const hipLesionNoRadio = sectionDiv.querySelector(`input[name="${prefix}hipLesion"][value="No"]`);
                if (hipLesionNoRadio) hipLesionNoRadio.checked = true;
                const hipFractureNoRadio = sectionDiv.querySelector(`input[name="${prefix}hipFracture"][value="No"]`);
                if (hipFractureNoRadio) hipFractureNoRadio.checked = true;
                const hipDislocationSubluxationNoRadio = sectionDiv.querySelector(`input[name="${prefix}hipDislocationSubluxation"][value="No"]`);
                if (hipDislocationSubluxationNoRadio) hipDislocationSubluxationNoRadio.checked = true;

            }, 0);

            return sectionDiv;
        }


        // Event listener for Modality selection
        modalitySelect.addEventListener('change', () => {
            const selectedModality = modalitySelect.value;
            studyTypeSelect.innerHTML = '<option value="">-- Please Select --</option>'; // Clear previous options
            studyTypeSelect.disabled = true;
            studyChecklistSection.classList.add('hidden'); // Hide checklist section by default
            dynamicSideChecklistsContainer.innerHTML = ''; // Clear dynamic sections
            clinicalHistoryTextarea.value = ''; // Clear clinical history
            reportOutput.value = ''; // Clear report output
            lateralityRadios.forEach(radio => radio.checked = false); // Reset laterality

            if (selectedModality === 'X-Ray') {
                studyTypeSelect.disabled = false;
                // Populate study types for X-Ray
                ['Knee', 'Shoulder', 'Hip', 'Ankle', 'Chest', 'Hand'].forEach(study => {
                    const option = document.createElement('option');
                    option.value = study;
                    option.textContent = study;
                    studyTypeSelect.appendChild(option);
                });
            }
        });

        // Event listener for Study Type selection
        studyTypeSelect.addEventListener('change', () => {
            currentStudyType = studyTypeSelect.value; // Update global currentStudyType
            studyChecklistSection.classList.add('hidden'); // Hide previous checklist
            dynamicSideChecklistsContainer.innerHTML = ''; // Clear dynamic sections
            clinicalHistoryTextarea.value = ''; // Clear clinical history
            reportOutput.value = ''; // Clear report output
            lateralityRadios.forEach(radio => radio.checked = false); // Reset laterality

            if (currentStudyType === 'Knee' || currentStudyType === 'Shoulder' || currentStudyType === 'Hip') {
                studyChecklistSection.classList.remove('hidden');
                studyChecklistTitle.textContent = `X-Ray ${currentStudyType} Checklist`;
            }
        });

        // Event listener for Laterality selection
        lateralityRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                dynamicSideChecklistsContainer.innerHTML = ''; // Clear previous side sections
                const selectedLaterality = radio.value;

                if (currentStudyType === 'Knee') {
                    if (selectedLaterality === 'Right') {
                        dynamicSideChecklistsContainer.appendChild(createKneeChecklistElements('right_', 'Right Knee', selectedLaterality));
                    } else if (selectedLaterality === 'Left') {
                        dynamicSideChecklistsContainer.appendChild(createKneeChecklistElements('left_', 'Left Knee', selectedLaterality));
                    } else if (selectedLaterality === 'Bilateral') {
                        dynamicSideChecklistsContainer.appendChild(createKneeChecklistElements('right_', 'Right Knee', selectedLaterality));
                        dynamicSideChecklistsContainer.appendChild(createKneeChecklistElements('left_', 'Left Knee', selectedLaterality));
                    }
                } else if (currentStudyType === 'Shoulder') {
                    if (selectedLaterality === 'Right') {
                        dynamicSideChecklistsContainer.appendChild(createShoulderChecklistElements('right_', 'Right Shoulder', selectedLaterality));
                    } else if (selectedLaterality === 'Left') {
                        dynamicSideChecklistsContainer.appendChild(createShoulderChecklistElements('left_', 'Left Shoulder', selectedLaterality));
                    } else if (selectedLaterality === 'Bilateral') {
                        dynamicSideChecklistsContainer.appendChild(createShoulderChecklistElements('right_', 'Right Shoulder', selectedLaterality));
                        dynamicSideChecklistsContainer.appendChild(createShoulderChecklistElements('left_', 'Left Shoulder', selectedLaterality));
                    }
                } else if (currentStudyType === 'Hip') {
                    if (selectedLaterality === 'Right') {
                        dynamicSideChecklistsContainer.appendChild(createHipChecklistElements('right_', 'Right Hip', selectedLaterality));
                    } else if (selectedLaterality === 'Left') {
                        dynamicSideChecklistsContainer.appendChild(createHipChecklistElements('left_', 'Left Hip', selectedLaterality));
                    } else if (selectedLaterality === 'Bilateral') {
                        dynamicSideChecklistsContainer.appendChild(createHipChecklistElements('right_', 'Right Hip', selectedLaterality));
                        dynamicSideChecklistsContainer.appendChild(createHipChecklistElements('left_', 'Left Hip', selectedLaterality));
                    }
                }
            });
        });

        // Function to get selected radio value for a given prefix
        function getRadioValue(name, prefix = '') {
            const radios = document.querySelectorAll(`input[name="${prefix}${name}"]:checked`);
            return radios.length > 0 ? radios[0].value : null;
        }

        // Function to get selected checkbox values for a given prefix
        function getCheckboxValues(name, prefix = '') {
            const checkboxes = document.querySelectorAll(`input[name="${prefix}${name}"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Function to get text input value for a given prefix
        function getInputValue(id, prefix = '') {
            const inputElement = document.getElementById(`${prefix}${id}`);
            return inputElement ? inputElement.value.trim() : '';
        }

        // Function to generate findings for a single knee
        function generateKneeFindings(prefix, kneeName, selectedLaterality) {
            const findings = [];
            const nameQualifier = (selectedLaterality === 'Bilateral') ? ` in ${kneeName}` : '';

            const degenerativeChanges = getRadioValue('degenerativeChanges', prefix);
            const selectedCompartments = getCheckboxValues('compartments', prefix);
            const osteophyte = getRadioValue('osteophyte', prefix);

            if (degenerativeChanges === 'Yes') {
                if (selectedCompartments.includes('Medial')) {
                    const medialSeverity = getRadioValue('medialSeverity', prefix);
                    if (medialSeverity) findings.push(`${medialSeverity} degenerative changes${nameQualifier} medial compartment.`);
                }
                if (selectedCompartments.includes('Lateral')) {
                    const lateralSeverity = getRadioValue('lateralSeverity', prefix);
                    if (lateralSeverity) findings.push(`${lateralSeverity} degenerative changes${nameQualifier} lateral compartment.`);
                }
                if (selectedCompartments.includes('Patellofemoral')) {
                    const patellofemoralSeverity = getRadioValue('patellofemoralSeverity', prefix);
                    if (patellofemoralSeverity) findings.push(`${patellofemoralSeverity} degenerative changes${nameQualifier} patellofemoral compartment.`);
                }

                if (osteophyte === 'Present') {
                    findings.push(`Osteophyte present${nameQualifier}.`);
                }
            }

            const fracture = getRadioValue('fracture', prefix);
            const fractureTypeLocation = getInputValue('fractureTypeLocation', prefix);
            if (fracture === 'Yes' && fractureTypeLocation) {
                findings.push(`Fracture${nameQualifier}: ${fractureTypeLocation}.`);
            }

            const jointEffusion = getRadioValue('jointEffusion', prefix);
            if (jointEffusion && jointEffusion !== 'None') {
                findings.push(`${jointEffusion} joint effusion${nameQualifier}.`);
            }

            const vascularCalcification = getRadioValue('vascularCalcification', prefix);
            if (vascularCalcification === 'Present') {
                findings.push(`Vascular calcifications are present${nameQualifier}.`);
            }

            const implants = getRadioValue('implants', prefix);
            const implantType = implants === 'Yes' ? getRadioValue('implantType', prefix) : null;
            const partialKneeCompartment = (implantType === 'Partial knee replacement' && implants === 'Yes') ? getInputValue('partialKneeCompartment', prefix) : '';
            const otherImplantType = (implantType === 'Others' && implants === 'Yes') ? getInputValue('otherImplantType', prefix) : '';

            if (implants === 'Yes') {
                if (implantType === 'TKR') {
                    findings.push(`Total knee replacement present${nameQualifier}.`);
                } else if (implantType === 'Partial knee replacement') {
                    findings.push(`Partial knee replacement present${nameQualifier}, involving the ${partialKneeCompartment || 'unspecified'} compartment.`);
                } else if (implantType === 'Others' && otherImplantType) {
                    findings.push(`Other implants present${nameQualifier}: ${otherImplantType}.`);
                }
            }

            const lesion = getRadioValue('lesion', prefix);
            const lesionRegion = getInputValue('lesionRegion', prefix);
            const lesionSize = getInputValue('lesionSize', prefix);
            if (lesion === 'Yes' && (lesionRegion || lesionSize)) {
                let lesionText = `Lesion identified${nameQualifier}`;
                if (lesionRegion) lesionText += ` in the ${lesionRegion}`;
                if (lesionSize) lesionText += ` measuring ${lesionSize}`;
                findings.push(lesionText + '.');
            }

            const postOpStatus = getRadioValue('postOpStatus', prefix);
            const postOpDescription = getInputValue('postOpDescription', prefix);
            if (postOpStatus === 'Yes' && postOpDescription) {
                findings.push(`Post-operative status${nameQualifier}: ${postOpDescription}.`);
            }

            return findings;
        }

        // Function to generate findings for a single shoulder
        function generateShoulderFindings(prefix, shoulderName, selectedLaterality) {
            const findings = [];
            const nameQualifier = (selectedLaterality === 'Bilateral') ? ` in ${shoulderName}` : '';
            let isDislocationPresent = false; // Flag for the pop-up

            // 1. Hardware
            const hardware = getRadioValue('hardware', prefix);
            const hardwareType = getRadioValue('hardwareType', prefix);
            const otherHardwareType = getInputValue('otherHardwareType', prefix);
            if (hardware === 'Present') {
                if (hardwareType === 'Others' && otherHardwareType) {
                    findings.push(`Hardware present${nameQualifier}: ${otherHardwareType}.`);
                } else if (hardwareType) {
                    findings.push(`Hardware present${nameQualifier}: ${hardwareType}.`);
                } else {
                    findings.push(`Hardware present${nameQualifier}.`);
                }
            }

            // 2. Post surgical changes / acute soft tissue changes
            const postSurgicalAcuteSoftTissue = getRadioValue('postSurgicalAcuteSoftTissue', prefix);
            if (postSurgicalAcuteSoftTissue === 'Yes') {
                findings.push(`Post surgical changes / acute soft tissue changes present${nameQualifier}.`);
            }

            // 3. Degenerative Changes
            const degenerativeChanges = getRadioValue('shoulderDegenerativeChanges', prefix);
            if (degenerativeChanges === 'Yes') {
                const degCompartments = getCheckboxValues('shoulderDegCompartments', prefix);
                if (degCompartments.includes('Glenohumeral')) {
                    const ghDegSeverity = getRadioValue('ghDegSeverity', prefix);
                    if (ghDegSeverity) findings.push(`${ghDegSeverity} degenerative changes${nameQualifier} in glenohumeral compartment.`);
                }
                if (degCompartments.includes('Acromioclavicular')) {
                    const acDegSeverity = getRadioValue('acDegSeverity', prefix);
                    if (acDegSeverity) findings.push(`${acDegSeverity} degenerative changes${nameQualifier} in AC compartment.`);
                }
                const osteophyte = getRadioValue('shoulderOsteophyte', prefix);
                if (osteophyte === 'Yes') { // Changed to 'Yes' as per new checklist
                    findings.push(`Osteophytes present${nameQualifier}.`);
                }

                const jointSpaceNarrowing = getRadioValue('shoulderJointSpaceNarrowing', prefix);
                if (jointSpaceNarrowing === 'Yes') {
                    const narrowingJoints = getCheckboxValues('shoulderNarrowingJoints', prefix);
                    if (narrowingJoints.length > 0) {
                        findings.push(`Joint space narrowing${nameQualifier} in ${narrowingJoints.join(', ')}.`);
                    } else {
                        findings.push(`Joint space narrowing present${nameQualifier}.`); // Fallback if no specific joint selected
                    }
                }
            }

            // 4. Fracture followup
            const fractureFollowup = getRadioValue('fractureFollowup', prefix);
            const oldHealedFractureRegion = getInputValue('oldHealedFractureRegion', prefix);
            const healingFractureRegion = getInputValue('healingFractureRegion', prefix);
            if (fractureFollowup === 'Yes') {
                if (oldHealedFractureRegion) {
                    findings.push(`Old healed fracture${nameQualifier}, region: ${oldHealedFractureRegion}.`);
                }
                if (healingFractureRegion) {
                    findings.push(`Healing fracture${nameQualifier}, region: ${healingFractureRegion}.`);
                }
            }

            // 5. Acute fracture
            const acuteFracture = getRadioValue('acuteFracture', prefix);
            const acuteFractureType = getInputValue('acuteFractureType', prefix);
            const acuteFractureRegion = getInputValue('acuteFractureRegion', prefix);
            if (acuteFracture === 'Yes') {
                let fractureText = `Acute fracture${nameQualifier}`;
                if (acuteFractureType) fractureText += `, type: ${acuteFractureType}`;
                if (acuteFractureRegion) fractureText += `, region: ${acuteFractureRegion}`;
                findings.push(`${fractureText}.`);
            }

            // 6. Rotator cuff calcification
            const rotatorCuffCalcification = getRadioValue('rotatorCuffCalcification', prefix);
            if (rotatorCuffCalcification === 'Yes') {
                findings.push(`Rotator cuff calcification present${nameQualifier}.`);
            }

            // 7. Lesion
            const lesion = getRadioValue('lesion', prefix);
            const lesionRegion = getInputValue('lesionRegion', prefix);
            const lesionSize = getInputValue('lesionSize', prefix);
            const lesionCharacteristics = getInputValue('lesionCharacteristics', prefix);
            if (lesion === 'Yes') {
                let lesionText = `Lesion identified${nameQualifier}`;
                if (lesionRegion) lesionText += ` in the ${lesionRegion}`;
                if (lesionSize) lesionText += ` measuring ${lesionSize}`;
                if (lesionCharacteristics) lesionText += ` (${lesionCharacteristics})`;
                findings.push(lesionText + '.');
            }

            // 8. Dislocation/ sublaxation
            const dislocationSubluxation = getRadioValue('dislocationSubluxation', prefix);
            if (dislocationSubluxation === 'Yes') {
                findings.push(`Dislocation/subluxation present${nameQualifier}.`);
                isDislocationPresent = true; // Set flag for modal
            }

            return { findings, isDislocationPresent }; // Return findings and the flag
        }

        // Function to generate findings for a single hip
        function generateHipFindings(prefix, hipName, selectedLaterality) {
            const findings = [];
            const nameQualifier = (selectedLaterality === 'Bilateral') ? ` in ${hipName}` : '';
            let isDislocationPresent = false; // Flag for the pop-up

            // 1. Hardware
            const hipHardware = getRadioValue('hipHardware', prefix);
            if (hipHardware === 'Present') {
                const hipHardwareType = getRadioValue('hipHardwareType', prefix);
                const hipOtherHardwareType = getInputValue('hipOtherHardwareType', prefix);
                if (hipHardwareType === 'Others' && hipOtherHardwareType) {
                    findings.push(`Hardware present${nameQualifier}: ${hipOtherHardwareType}.`);
                } else if (hipHardwareType) {
                    findings.push(`Hardware present${nameQualifier}: ${hipHardwareType}.`);
                } else {
                    findings.push(`Hardware present${nameQualifier}.`);
                }
            }

            // 2. Degenerative changes
            const hipDegenerativeChanges = getRadioValue('hipDegenerativeChanges', prefix);
            if (hipDegenerativeChanges === 'Yes') {
                const hipDegSeverity = getRadioValue('hipDegSeverity', prefix);
                if (hipDegSeverity) findings.push(`${hipDegSeverity} degenerative changes${nameQualifier}.`);

                const hipJointSpaceNarrowing = getRadioValue('hipJointSpaceNarrowing', prefix);
                if (hipJointSpaceNarrowing === 'Yes') {
                    findings.push(`Joint space narrowing present${nameQualifier}.`);
                }
                const hipOsteophytes = getRadioValue('hipOsteophytes', prefix);
                if (hipOsteophytes === 'Yes') {
                    findings.push(`Osteophytes present${nameQualifier}.`);
                }
                const hipScleroticChanges = getRadioValue('hipScleroticChanges', prefix);
                if (hipScleroticChanges === 'Yes') {
                    findings.push(`Sclerotic changes present${nameQualifier}.`);
                }
            }

            // 3. Heterotopic calcification
            const heterotopicCalcification = getRadioValue('heterotopicCalcification', prefix);
            if (heterotopicCalcification === 'Yes') {
                const heterotopicRegions = getCheckboxValues('heterotopicRegions', prefix);
                if (heterotopicRegions.length > 0) {
                    findings.push(`Heterotopic calcification present${nameQualifier} in ${heterotopicRegions.join(', ')}.`);
                } else {
                    findings.push(`Heterotopic calcification present${nameQualifier}.`);
                }
            }

            // 4. Vascular calcification
            const hipVascularCalcification = getRadioValue('hipVascularCalcification', prefix);
            if (hipVascularCalcification === 'Yes') {
                findings.push(`Vascular calcifications are present${nameQualifier}.`);
            }

            // 5. Lesion
            const hipLesion = getRadioValue('hipLesion', prefix);
            if (hipLesion === 'Yes') {
                const hipLesionRegion = getInputValue('hipLesionRegion', prefix);
                const hipLesionSize = getInputValue('hipLesionSize', prefix);
                const hipLesionCharacteristics = getInputValue('hipLesionCharacteristics', prefix);
                let lesionText = `Lesion identified${nameQualifier}`;
                if (hipLesionRegion) lesionText += ` in the ${hipLesionRegion}`;
                if (hipLesionSize) lesionText += ` measuring ${hipLesionSize}`;
                if (hipLesionCharacteristics) lesionText += ` (${hipLesionCharacteristics})`;
                findings.push(lesionText + '.');
            }

            // 6. Fracture
            const hipFracture = getRadioValue('hipFracture', prefix);
            if (hipFracture === 'Yes') {
                const hipFractureRegions = getCheckboxValues('hipFractureRegions', prefix);
                if (hipFractureRegions.includes('Femoral head')) {
                    const type = getInputValue('femoralHeadFractureType', prefix);
                    findings.push(`Fracture${nameQualifier} of femoral head: ${type || 'unspecified type'}.`);
                }
                if (hipFractureRegions.includes('Acetabulum')) {
                    const type = getInputValue('acetabulumFractureType', prefix);
                    findings.push(`Fracture${nameQualifier} of acetabulum: ${type || 'unspecified type'}.`);
                }
                if (hipFractureRegions.includes('Superior pubic ramus')) {
                    const type = getInputValue('sprFractureType', prefix);
                    findings.push(`Fracture${nameQualifier} of superior pubic ramus: ${type || 'unspecified type'}.`);
                }
                if (hipFractureRegions.includes('Inferior pubic ramus')) {
                    const type = getInputValue('iprFractureType', prefix);
                    findings.push(`Fracture${nameQualifier} of inferior pubic ramus: ${type || 'unspecified type'}.`);
                }
                if (hipFractureRegions.includes('Femoral neck')) {
                    const type = getInputValue('femoralNeckFractureType', prefix);
                    findings.push(`Fracture${nameQualifier} of femoral neck: ${type || 'unspecified type'}.`);
                }
            }

            // 7. Dislocation/Subluxation
            const hipDislocationSubluxation = getRadioValue('hipDislocationSubluxation', prefix);
            if (hipDislocationSubluxation === 'Yes') {
                findings.push(`Dislocation/subluxation present${nameQualifier}.`);
                isDislocationPresent = true; // Set flag for modal
            }

            return { findings, isDislocationPresent };
        }


        // Function to generate the overall report transcript
        generateReportBtn.addEventListener('click', () => {
            const clinicalHistory = clinicalHistoryTextarea.value.trim();
            const laterality = getRadioValue('laterality');

            let report = "FINDINGS:\n\n";
            let allFindings = [];
            let findingCounter = 1;
            let shouldShowDislocationWarning = false;

            if (clinicalHistory) {
                report = `CLINICAL HISTORY: ${clinicalHistory}\n\n` + report;
            }

            if (laterality && currentStudyType) {
                report = `STUDY: X-Ray ${laterality} ${currentStudyType}\n\n` + report;
            }

            if (currentStudyType === 'Knee') {
                if (laterality === 'Right') {
                    const rightFindings = generateKneeFindings('right_', 'right knee', laterality);
                    allFindings = allFindings.concat(rightFindings);
                } else if (laterality === 'Left') {
                    const leftFindings = generateKneeFindings('left_', 'left knee', laterality);
                    allFindings = allFindings.concat(leftFindings);
                } else if (laterality === 'Bilateral') {
                    const rightFindings = generateKneeFindings('right_', 'right knee', laterality);
                    const leftFindings = generateKneeFindings('left_', 'left knee', laterality);
                    allFindings = allFindings.concat(rightFindings).concat(leftFindings);
                }
            } else if (currentStudyType === 'Shoulder') {
                if (laterality === 'Right') {
                    const { findings, isDislocationPresent } = generateShoulderFindings('right_', 'right shoulder', laterality);
                    allFindings = allFindings.concat(findings);
                    if (isDislocationPresent) shouldShowDislocationWarning = true;
                } else if (laterality === 'Left') {
                    const { findings, isDislocationPresent } = generateShoulderFindings('left_', 'left shoulder', laterality);
                    allFindings = allFindings.concat(findings);
                    if (isDislocationPresent) shouldShowDislocationWarning = true;
                } else if (laterality === 'Bilateral') {
                    const { findings: rightFindings, isDislocationPresent: rightDislocation } = generateShoulderFindings('right_', 'right shoulder', laterality);
                    const { findings: leftFindings, isDislocationPresent: leftDislocation } = generateShoulderFindings('left_', 'left shoulder', laterality);
                    allFindings = allFindings.concat(rightFindings).concat(leftFindings);
                    if (rightDislocation || leftDislocation) shouldShowDislocationWarning = true;
                }
            } else if (currentStudyType === 'Hip') {
                if (laterality === 'Right') {
                    const { findings, isDislocationPresent } = generateHipFindings('right_', 'right hip', laterality);
                    allFindings = allFindings.concat(findings);
                    if (isDislocationPresent) shouldShowDislocationWarning = true;
                } else if (laterality === 'Left') {
                    const { findings, isDislocationPresent } = generateHipFindings('left_', 'left hip', laterality);
                    allFindings = allFindings.concat(findings);
                    if (isDislocationPresent) shouldShowDislocationWarning = true;
                } else if (laterality === 'Bilateral') {
                    const { findings: rightFindings, isDislocationPresent: rightDislocation } = generateHipFindings('right_', 'right hip', laterality);
                    const { findings: leftFindings, isDislocationPresent: leftDislocation } = generateHipFindings('left_', 'left hip', laterality);
                    allFindings = allFindings.concat(rightFindings).concat(leftFindings);
                    if (rightDislocation || leftDislocation) shouldShowDislocationWarning = true;
                }
            }


            if (allFindings.length > 0) {
                report += allFindings.map((f) => `${findingCounter++}. ${f}`).join('\n');
            } else {
                report += "No positive findings to report based on selections.";
            }

            reportOutput.value = report;

            // Show dislocation warning modal if needed
            if (shouldShowDislocationWarning) {
                dislocationModal.classList.remove('hidden');
            }
        });

        // Function to clear the entire form
        clearFormBtn.addEventListener('click', () => {
            modalitySelect.value = '';
            studyTypeSelect.innerHTML = '<option value="">-- Please Select --</option>';
            studyTypeSelect.disabled = true;

            studyChecklistSection.classList.add('hidden');
            clinicalHistoryTextarea.value = '';
            lateralityRadios.forEach(radio => radio.checked = false);
            dynamicSideChecklistsContainer.innerHTML = '';
            reportOutput.value = '';
            copyMessage.classList.remove('show');
            currentStudyType = ''; // Reset current study type
            dislocationModal.classList.add('hidden'); // Hide modal on clear
        });


        // Copy to clipboard functionality
        copyReportBtn.addEventListener('click', () => {
            reportOutput.select();
            reportOutput.setSelectionRange(0, 99999);
            document.execCommand('copy');

            copyMessage.classList.add('show');
            setTimeout(() => {
                copyMessage.classList.remove('show');
            }, 2000);
        });

        // Initial state setup
        studyChecklistSection.classList.add('hidden');

    </script>
</body>
</html>
