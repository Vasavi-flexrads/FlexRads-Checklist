<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlexRads Checklist</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom cherry-red color palette */
        :root {
            --flexrads-red: #E74C3C; /* A brighter, more vibrant red */
            --flexrads-dark-red: #C0392B; /* Darker red for hover states */
            --dark-background: #1A1A1A; /* Slightly lighter dark for main background */
            --content-background: #282828; /* Darker gray for content sections */
            --text-color: #ECF0F1; /* Off-white for general text */
            --border-color: #444444; /* Medium gray for borders */
            --input-background: #333333; /* Dark gray for input fields */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-background);
            color: var(--text-color);
        }

        /* Styling for the main container */
        .container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: var(--content-background);
            border-radius: 1rem;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6); /* More prominent shadow */
            position: relative; /* Needed for absolute positioning of logo */
        }

        /* Headings */
        h1, h2, h3 {
            color: var(--flexrads-red); /* Use the vibrant red for headings */
            font-weight: bold;
            margin-bottom: 1rem;
        }

        /* Labels for form elements */
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        /* Input fields and textareas */
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
            background-color: var(--input-background);
            color: var(--text-color);
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--flexrads-red); /* Vibrant red on focus */
        }

        /* Radio and checkbox styling */
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            transition: background-color 0.2s, border-color 0.2s;
        }

        .radio-option:hover, .checkbox-option:hover {
            background-color: #3A3A3A; /* Slightly lighter dark gray on hover */
            border-color: var(--flexrads-red); /* Vibrant red on hover */
        }

        .radio-option input[type="radio"],
        .checkbox-option input[type="checkbox"] {
            margin-right: 0.5rem;
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #666;
            border-radius: 50%; /* For radio buttons */
            background-color: #333;
            position: relative;
            cursor: pointer;
            flex-shrink: 0;
        }

        .checkbox-option input[type="checkbox"] {
            border-radius: 0.25rem; /* For checkboxes */
        }

        .radio-option input[type="radio"]:checked,
        .checkbox-option input[type="checkbox"]:checked {
            background-color: var(--flexrads-red); /* Vibrant red when checked */
            border-color: var(--flexrads-red);
        }

        /* Inner circle for checked radio button */
        .radio-option input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 0.6rem;
            height: 0.6rem;
            background-color: #fff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Checkmark for checked checkbox */
        .checkbox-option input[type="checkbox"]:checked::after {
            content: '\2713'; /* Checkmark character */
            display: block;
            color: #fff;
            font-size: 0.8rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Button styling */
        .action-button { /* General class for action buttons */
            background-color: var(--flexrads-red);
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            border: none;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6); /* Even more prominent shadow */
            display: inline-block; /* Ensure it respects margin/padding */
        }

        .action-button:hover {
            background-color: var(--flexrads-dark-red);
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.7);
        }

        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.5);
        }

        /* Report output area */
        #reportOutput {
            min-height: 200px;
            background-color: var(--input-background);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word; /* Break long words */
            font-family: monospace;
            color: var(--text-color);
        }

        /* Hidden class */
        .hidden {
            display: none;
        }

        /* Copy button styling (specific for the icon button) */
        .copy-btn {
            background: none;
            border: none;
            color: var(--flexrads-red);
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 0.5rem;
            padding: 0.2rem;
            border-radius: 0.3rem;
            transition: background-color 0.2s, color 0.2s;
            box-shadow: none; /* Override general button shadow */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .copy-btn:hover {
            background-color: rgba(231, 76, 60, 0.2); /* Light red hover */
            color: var(--flexrads-red);
            transform: none; /* Override general button lift */
            box-shadow: none; /* Override general button shadow */
        }

        .copy-btn:active {
            background-color: rgba(231, 76, 60, 0.4);
            transform: none;
            box-shadow: none;
        }

        /* Copy confirmation message */
        .copy-message {
            margin-left: 1rem;
            color: #27AE60; /* Green color for success */
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .copy-message.show {
            opacity: 1;
        }

        /* Section for individual knee checklists */
        .knee-side-section {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            background-color: #222222; /* Slightly different background for sub-sections */
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-3xl text-center mb-6">FlexRads Checklist</h1>

        <!-- Modality and Study Selection -->
        <div class="mb-6 p-4 border border-gray-700 rounded-lg">
            <h2 class="text-xl mb-4">Study Selection</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="modalitySelect" class="block">Select Modality:</label>
                    <select id="modalitySelect" class="w-full">
                        <option value="">-- Please Select --</option>
                        <option value="X-Ray">X-Ray</option>
                        <option value="CT">CT</option>
                        <option value="MRI">MRI</option>
                        <option value="Ultrasound">Ultrasound</option>
                    </select>
                </div>
                <div>
                    <label for="studyTypeSelect" class="block">Select Study Type:</label>
                    <select id="studyTypeSelect" class="w-full" disabled>
                        <option value="">-- Please Select --</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- X-Ray Knee Checklist Section (Main container for laterality) -->
        <div id="kneeChecklistSection" class="hidden p-4 border border-gray-700 rounded-lg">
            <h2 class="text-xl mb-4">X-Ray Knee Checklist</h2>

            <!-- Clinical History -->
            <div class="mb-4">
                <label for="clinicalHistory" class="block">Clinical History:</label>
                <textarea id="clinicalHistory" rows="3" placeholder="Enter clinical history..."></textarea>
            </div>

            <!-- Laterality -->
            <div class="mb-4">
                <label class="block">Laterality:</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="laterality" value="Right"> Right
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="laterality" value="Left"> Left
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="laterality" value="Bilateral"> Bilateral
                    </label>
                </div>
            </div>

            <div id="dynamicKneeChecklists">
                <!-- Dynamic knee checklists will be inserted here by JavaScript -->
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center gap-4 mt-6">
                <button id="generateReportBtn" class="action-button">Generate Report</button>
                <button id="clearFormBtn" class="action-button">Clear Form</button>
            </div>
        </div>

        <!-- Report Output Area -->
        <div class="mt-8 p-4 border border-gray-700 rounded-lg">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl">Report Transcript</h2>
                <div class="flex items-center">
                    <button id="copyReportBtn" class="copy-btn" title="Copy to Clipboard">
                        <!-- Clipboard icon (SVG for better styling and control) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-copy">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                    <span id="copyMessage" class="copy-message">Copied!</span>
                </div>
            </div>
            <textarea id="reportOutput" readonly class="w-full"></textarea>
        </div>
    </div>

    <script>
        // DOM element references
        const modalitySelect = document.getElementById('modalitySelect');
        const studyTypeSelect = document.getElementById('studyTypeSelect');
        const kneeChecklistSection = document.getElementById('kneeChecklistSection');
        const lateralityRadios = document.querySelectorAll('input[name="laterality"]');
        const dynamicKneeChecklistsContainer = document.getElementById('dynamicKneeChecklists');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const clearFormBtn = document.getElementById('clearFormBtn'); // New Clear button
        const reportOutput = document.getElementById('reportOutput');
        const copyReportBtn = document.getElementById('copyReportBtn');
        const copyMessage = document.getElementById('copyMessage');
        const clinicalHistoryTextarea = document.getElementById('clinicalHistory');


        // Helper function to update visibility of conditional fields
        function updateConditionalVisibility(radioGroup, targetElement) {
            radioGroup.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.value === 'Yes' || radio.value === 'Present') {
                        targetElement.classList.remove('hidden');
                    } else {
                        targetElement.classList.add('hidden');
                        // Reset inputs within hidden sections to avoid stale data
                        targetElement.querySelectorAll('input[type="text"], input[type="checkbox"], input[type="radio"]').forEach(input => {
                            if (input.type === 'text') input.value = '';
                            if (input.type === 'checkbox' || input.type === 'radio') input.checked = false;
                        });
                        // For radio groups, ensure a default 'No' or 'Absent' is selected if available
                        const defaultRadio = targetElement.querySelector('input[value="No"], input[value="Absent"], input[value="None"]');
                        if (defaultRadio) defaultRadio.checked = true;
                    }
                });
            });
        }

        /**
         * Creates and returns a DOM element for a single knee checklist section.
         * @param {string} prefix - A unique prefix for input names and IDs (e.g., 'right_', 'left_').
         * @param {string} title - The display title for this knee section (e.g., 'Right Knee', 'Left Knee').
         * @returns {HTMLElement} The created div element containing the checklist.
         */
        function createKneeChecklistElements(prefix, title) {
            const sectionDiv = document.createElement('div');
            sectionDiv.id = `${prefix}KneeSection`;
            sectionDiv.className = 'knee-side-section mt-6'; // Added class for styling

            sectionDiv.innerHTML = `
                <h3 class="text-xl mb-4">${title} Checklist Items:</h3>

                <!-- 1. Degenerative Changes -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">1. Degenerative changes:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}degenerativeChanges" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}degenerativeChanges" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}degenerativeDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <label class="block mb-2">Compartments (multi-select):</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}compartments" value="Medial" data-severity-target="${prefix}medialSeverityDetails"> Medial
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}compartments" value="Lateral" data-severity-target="${prefix}lateralSeverityDetails"> Lateral
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="${prefix}compartments" value="Patellofemoral" data-severity-target="${prefix}patellofemoralSeverityDetails"> Patellofemoral
                            </label>
                        </div>

                        <!-- Severity for Medial Compartment -->
                        <div id="${prefix}medialSeverityDetails" class="hidden mt-2">
                            <label class="block mb-2">Medial Compartment Severity:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}medialSeverity" value="Mild"> Mild
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}medialSeverity" value="Moderate"> Moderate
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}medialSeverity" value="Severe"> Severe
                                </label>
                            </div>
                        </div>

                        <!-- Severity for Lateral Compartment -->
                        <div id="${prefix}lateralSeverityDetails" class="hidden mt-2">
                            <label class="block mb-2">Lateral Compartment Severity:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}lateralSeverity" value="Mild"> Mild
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}lateralSeverity" value="Moderate"> Moderate
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}lateralSeverity" value="Severe"> Severe
                                </label>
                            </div>
                        </div>

                        <!-- Severity for Patellofemoral Compartment -->
                        <div id="${prefix}patellofemoralSeverityDetails" class="hidden mt-2">
                            <label class="block mb-2">Patellofemoral Compartment Severity:</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}patellofemoralSeverity" value="Mild"> Mild
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}patellofemoralSeverity" value="Moderate"> Moderate
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="${prefix}patellofemoralSeverity" value="Severe"> Severe
                                </label>
                            </div>
                        </div>

                        <label class="block mb-2">Osteophyte:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}osteophyte" value="Present"> Present
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}osteophyte" value="Absent" checked> Absent
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 2. Fracture -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">2. Fracture:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}fracture" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}fracture" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}fractureDetails" class="hidden mt-2">
                        <label for="${prefix}fractureTypeLocation" class="block">Type and Location:</label>
                        <input type="text" id="${prefix}fractureTypeLocation" placeholder="e.g., Tibial plateau fracture, non-displaced">
                    </div>
                </div>

                <!-- 3. Joint Effusion -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">3. Joint effusion:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}jointEffusion" value="None" checked> None
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}jointEffusion" value="Mild"> Mild
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}jointEffusion" value="Moderate"> Moderate
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}jointEffusion" value="Severe"> Severe
                        </label>
                    </div>
                </div>

                <!-- 4. Vascular Calcification -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">4. Vascular calcification:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}vascularCalcification" value="Present"> Present
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}vascularCalcification" value="Absent" checked> Absent
                        </label>
                    </div>
                </div>

                <!-- 5. Any Implants -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">5. Any Implants:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}implants" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}implants" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}implantsDetails" class="hidden mt-2 p-2 border border-gray-700 rounded-md">
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="${prefix}implantType" value="TKR"> TKR (Total Knee Replacement)
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}implantType" value="Partial knee replacement"> Partial knee replacement
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="${prefix}implantType" value="Others"> Others
                            </label>
                        </div>
                        <div id="${prefix}partialKneeDetails" class="hidden mt-2">
                            <label for="${prefix}partialKneeCompartment" class="block">Compartment:</label>
                            <input type="text" id="${prefix}partialKneeCompartment" placeholder="e.g., Medial">
                        </div>
                        <div id="${prefix}otherImplantsDetails" class="hidden mt-2">
                            <label for="${prefix}otherImplantType" class="block">Specify Other:</label>
                            <input type="text" id="${prefix}otherImplantType" placeholder="e.g., Screws, plates">
                        </div>
                    </div>
                </div>

                <!-- 6. Lesion -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">6. Lesion:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}lesion" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}lesion" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}lesionDetails" class="hidden mt-2">
                        <label for="${prefix}lesionRegion" class="block">Region:</label>
                        <input type="text" id="${prefix}lesionRegion" placeholder="e.g., Distal femur">
                        <label for="${prefix}lesionSize" class="block">Size:</label>
                        <input type="text" id="${prefix}lesionSize" placeholder="e.g., 2x3 cm">
                    </div>
                </div>

                <!-- 7. Post op -->
                <div class="mb-4 p-3 border border-gray-800 rounded-md">
                    <label class="block">7. Post op:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="${prefix}postOpStatus" value="Yes"> Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="${prefix}postOpStatus" value="No" checked> No
                        </label>
                    </div>
                    <div id="${prefix}postOpDetails" class="hidden mt-2">
                        <label for="${prefix}postOpDescription" class="block">Description:</label>
                        <input type="text" id="${prefix}postOpDescription" placeholder="e.g., Status post ACL reconstruction">
                    </div>
                </div>
            `;

            // Attach event listeners for the dynamically created elements
            // This needs to be done AFTER the HTML is inserted into the DOM
            setTimeout(() => { // Use a small timeout to ensure elements are in DOM
                const degenerativeChangesRadios = sectionDiv.querySelectorAll(`input[name="${prefix}degenerativeChanges"]`);
                const degenerativeDetails = sectionDiv.querySelector(`#${prefix}degenerativeDetails`);
                updateConditionalVisibility(degenerativeChangesRadios, degenerativeDetails);

                const compartmentCheckboxes = sectionDiv.querySelectorAll(`input[name="${prefix}compartments"]`);
                compartmentCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const targetId = checkbox.dataset.severityTarget;
                        const targetElement = sectionDiv.querySelector(`#${targetId}`);
                        if (checkbox.checked) {
                            targetElement.classList.remove('hidden');
                            const defaultSeverityRadio = targetElement.querySelector('input[type="radio"]');
                            if (defaultSeverityRadio && !targetElement.querySelector('input[type="radio"]:checked')) {
                                defaultSeverityRadio.checked = true;
                            }
                        } else {
                            targetElement.classList.add('hidden');
                            targetElement.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                        }
                    });
                });

                const fractureRadios = sectionDiv.querySelectorAll(`input[name="${prefix}fracture"]`);
                const fractureDetails = sectionDiv.querySelector(`#${prefix}fractureDetails`);
                updateConditionalVisibility(fractureRadios, fractureDetails);

                const implantsRadios = sectionDiv.querySelectorAll(`input[name="${prefix}implants"]`);
                const implantsDetails = sectionDiv.querySelector(`#${prefix}implantsDetails`);
                updateConditionalVisibility(implantsRadios, implantsDetails);

                const implantTypeRadios = sectionDiv.querySelectorAll(`input[name="${prefix}implantType"]`);
                const partialKneeDetails = sectionDiv.querySelector(`#${prefix}partialKneeDetails`);
                const otherImplantsDetails = sectionDiv.querySelector(`#${prefix}otherImplantsDetails`);
                implantTypeRadios.forEach(radio => {
                    radio.addEventListener('change', () => {
                        partialKneeDetails.classList.add('hidden');
                        otherImplantsDetails.classList.add('hidden');
                        sectionDiv.querySelector(`#${prefix}partialKneeCompartment`).value = '';
                        sectionDiv.querySelector(`#${prefix}otherImplantType`).value = '';

                        if (radio.value === 'Partial knee replacement') {
                            partialKneeDetails.classList.remove('hidden');
                        } else if (radio.value === 'Others') {
                            otherImplantsDetails.classList.remove('hidden');
                        }
                    });
                });

                const lesionRadios = sectionDiv.querySelectorAll(`input[name="${prefix}lesion"]`);
                const lesionDetails = sectionDiv.querySelector(`#${prefix}lesionDetails`);
                updateConditionalVisibility(lesionRadios, lesionDetails);

                const postOpStatusRadios = sectionDiv.querySelectorAll(`input[name="${prefix}postOpStatus"]`);
                const postOpDetails = sectionDiv.querySelector(`#${prefix}postOpDetails`);
                updateConditionalVisibility(postOpStatusRadios, postOpDetails);

                // Ensure initial default states for dynamically created elements
                sectionDiv.querySelector(`input[name="${prefix}degenerativeChanges"][value="No"]`).checked = true;
                sectionDiv.querySelector(`input[name="${prefix}fracture"][value="No"]`).checked = true;
                sectionDiv.querySelector(`input[name="${prefix}jointEffusion"][value="None"]`).checked = true;
                sectionDiv.querySelector(`input[name="${prefix}vascularCalcification"][value="Absent"]`).checked = true;
                sectionDiv.querySelector(`input[name="${prefix}implants"][value="No"]`).checked = true;
                sectionDiv.querySelector(`input[name="${prefix}lesion"][value="No"]`).checked = true;
                sectionDiv.querySelector(`input[name="${prefix}postOpStatus"][value="No"]`).checked = true;

            }, 0); // Small timeout to ensure elements are parsed by the browser

            return sectionDiv;
        }

        // Event listener for Modality selection
        modalitySelect.addEventListener('change', () => {
            const selectedModality = modalitySelect.value;
            studyTypeSelect.innerHTML = '<option value="">-- Please Select --</option>'; // Clear previous options
            studyTypeSelect.disabled = true;
            kneeChecklistSection.classList.add('hidden'); // Hide knee checklist by default
            dynamicKneeChecklistsContainer.innerHTML = ''; // Clear dynamic sections

            if (selectedModality === 'X-Ray') {
                studyTypeSelect.disabled = false;
                // Populate study types for X-Ray
                ['Knee', 'Ankle', 'Chest', 'Hand'].forEach(study => {
                    const option = document.createElement('option');
                    option.value = study;
                    option.textContent = study;
                    studyTypeSelect.appendChild(option);
                });
            }
        });

        // Event listener for Study Type selection
        studyTypeSelect.addEventListener('change', () => {
            const selectedStudyType = studyTypeSelect.value;
            if (selectedStudyType === 'Knee') {
                kneeChecklistSection.classList.remove('hidden');
                // Ensure laterality radios are reset and handled
                lateralityRadios.forEach(radio => radio.checked = false);
                dynamicKneeChecklistsContainer.innerHTML = ''; // Clear any previous dynamic sections
            } else {
                kneeChecklistSection.classList.add('hidden');
                dynamicKneeChecklistsContainer.innerHTML = '';
            }
        });

        // Event listener for Laterality selection
        lateralityRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                dynamicKneeChecklistsContainer.innerHTML = ''; // Clear previous knee sections

                if (radio.value === 'Right') {
                    dynamicKneeChecklistsContainer.appendChild(createKneeChecklistElements('right_', 'Right Knee'));
                } else if (radio.value === 'Left') {
                    dynamicKneeChecklistsContainer.appendChild(createKneeChecklistElements('left_', 'Left Knee'));
                } else if (radio.value === 'Bilateral') {
                    dynamicKneeChecklistsContainer.appendChild(createKneeChecklistElements('right_', 'Right Knee'));
                    dynamicKneeChecklistsContainer.appendChild(createKneeChecklistElements('left_', 'Left Knee'));
                }
            });
        });

        // Function to get selected radio value for a given prefix
        function getRadioValue(name, prefix = '') {
            const radios = document.querySelectorAll(`input[name="${prefix}${name}"]:checked`);
            return radios.length > 0 ? radios[0].value : null;
        }

        // Function to get selected checkbox values for a given prefix
        function getCheckboxValues(name, prefix = '') {
            const checkboxes = document.querySelectorAll(`input[name="${prefix}${name}"]:checked`);
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Function to get text input value for a given prefix
        function getInputValue(id, prefix = '') {
            const inputElement = document.getElementById(`${prefix}${id}`);
            return inputElement ? inputElement.value.trim() : '';
        }

        // Function to generate findings for a single knee
        function generateKneeFindings(prefix, kneeName) {
            const findings = [];

            const degenerativeChanges = getRadioValue('degenerativeChanges', prefix);
            const selectedCompartments = getCheckboxValues('compartments', prefix);
            const osteophyte = getRadioValue('osteophyte', prefix);

            if (degenerativeChanges === 'Yes') {
                if (selectedCompartments.includes('Medial')) {
                    const medialSeverity = getRadioValue('medialSeverity', prefix);
                    if (medialSeverity) findings.push(`${medialSeverity} degenerative changes in ${kneeName} medial compartment.`);
                }
                if (selectedCompartments.includes('Lateral')) {
                    const lateralSeverity = getRadioValue('lateralSeverity', prefix);
                    if (lateralSeverity) findings.push(`${lateralSeverity} degenerative changes in ${kneeName} lateral compartment.`);
                }
                if (selectedCompartments.includes('Patellofemoral')) {
                    const patellofemoralSeverity = getRadioValue('patellofemoralSeverity', prefix);
                    if (patellofemoralSeverity) findings.push(`${patellofemoralSeverity} degenerative changes in ${kneeName} patellofemoral compartment.`);
                }

                if (osteophyte === 'Present') {
                    findings.push(`Osteophyte present in ${kneeName}.`);
                }
            }

            const fracture = getRadioValue('fracture', prefix);
            const fractureTypeLocation = getInputValue('fractureTypeLocation', prefix);
            if (fracture === 'Yes' && fractureTypeLocation) {
                findings.push(`Fracture in ${kneeName}: ${fractureTypeLocation}.`);
            }

            const jointEffusion = getRadioValue('jointEffusion', prefix);
            if (jointEffusion && jointEffusion !== 'None') {
                findings.push(`${jointEffusion} joint effusion in ${kneeName}.`);
            }

            const vascularCalcification = getRadioValue('vascularCalcification', prefix);
            if (vascularCalcification === 'Present') {
                findings.push(`Vascular calcifications are present in ${kneeName}.`);
            }

            const implants = getRadioValue('implants', prefix);
            const implantType = implants === 'Yes' ? getRadioValue('implantType', prefix) : null;
            const partialKneeCompartment = (implantType === 'Partial knee replacement' && implants === 'Yes') ? getInputValue('partialKneeCompartment', prefix) : '';
            const otherImplantType = (implantType === 'Others' && implants === 'Yes') ? getInputValue('otherImplantType', prefix) : '';

            if (implants === 'Yes') {
                if (implantType === 'TKR') {
                    findings.push(`Total knee replacement present in ${kneeName}.`);
                } else if (implantType === 'Partial knee replacement') {
                    findings.push(`Partial knee replacement present in ${kneeName}, involving the ${partialKneeCompartment || 'unspecified'} compartment.`);
                } else if (implantType === 'Others' && otherImplantType) {
                    findings.push(`Other implants present in ${kneeName}: ${otherImplantType}.`);
                }
            }

            const lesion = getRadioValue('lesion', prefix);
            const lesionRegion = getInputValue('lesionRegion', prefix);
            const lesionSize = getInputValue('lesionSize', prefix);
            if (lesion === 'Yes' && (lesionRegion || lesionSize)) {
                let lesionText = `Lesion identified in ${kneeName}`;
                if (lesionRegion) lesionText += ` in the ${lesionRegion}`;
                if (lesionSize) lesionText += ` measuring ${lesionSize}`;
                findings.push(lesionText + '.');
            }

            const postOpStatus = getRadioValue('postOpStatus', prefix);
            const postOpDescription = getInputValue('postOpDescription', prefix);
            if (postOpStatus === 'Yes' && postOpDescription) {
                findings.push(`Post-operative status in ${kneeName}: ${postOpDescription}.`);
            }

            return findings;
        }


        // Function to generate the overall report transcript
        generateReportBtn.addEventListener('click', () => {
            const clinicalHistory = clinicalHistoryTextarea.value.trim();
            const laterality = getRadioValue('laterality');

            let report = "FINDINGS:\n\n";
            let allFindings = [];
            let findingCounter = 1; // To ensure sequential numbering across all findings

            // Add clinical history if provided
            if (clinicalHistory) {
                report = `CLINICAL HISTORY: ${clinicalHistory}\n\n` + report;
            }

            // Add laterality to study description
            if (laterality) {
                report = `STUDY: X-Ray ${laterality} Knee\n\n` + report;
            }

            if (laterality === 'Right') {
                const rightFindings = generateKneeFindings('right_', 'right knee');
                allFindings = allFindings.concat(rightFindings);
            } else if (laterality === 'Left') {
                const leftFindings = generateKneeFindings('left_', 'left knee');
                allFindings = allFindings.concat(leftFindings);
            } else if (laterality === 'Bilateral') {
                const rightFindings = generateKneeFindings('right_', 'right knee');
                const leftFindings = generateKneeFindings('left_', 'left knee');
                allFindings = allFindings.concat(rightFindings).concat(leftFindings);
            }


            // Format findings into numbered list
            if (allFindings.length > 0) {
                report += allFindings.map((f) => `${findingCounter++}. ${f}`).join('\n');
            } else {
                report += "No positive findings to report based on selections.";
            }

            reportOutput.value = report;
        });

        // Function to clear the entire form
        clearFormBtn.addEventListener('click', () => {
            // Reset Modality and Study Type
            modalitySelect.value = '';
            studyTypeSelect.innerHTML = '<option value="">-- Please Select --</option>';
            studyTypeSelect.disabled = true;

            // Hide the main knee checklist section
            kneeChecklistSection.classList.add('hidden');

            // Clear Clinical History
            clinicalHistoryTextarea.value = '';

            // Reset Laterality radios
            lateralityRadios.forEach(radio => radio.checked = false);

            // Clear dynamic knee checklist sections
            dynamicKneeChecklistsContainer.innerHTML = '';

            // Clear report output
            reportOutput.value = '';

            // Hide copy message if visible
            copyMessage.classList.remove('show');

            // Note: Since knee sections are dynamically created, they are cleared by
            // dynamicKneeChecklistsContainer.innerHTML = ''; when laterality changes or is cleared.
            // If laterality is not selected, no knee sections will be visible.
        });


        // Copy to clipboard functionality
        copyReportBtn.addEventListener('click', () => {
            reportOutput.select(); // Select the text in the textarea
            reportOutput.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy'); // Copy the text

            // Show confirmation message
            copyMessage.classList.add('show');
            setTimeout(() => {
                copyMessage.classList.remove('show');
            }, 2000); // Hide after 2 seconds
        });

        // Initial state setup (hide knee checklist by default)
        kneeChecklistSection.classList.add('hidden');

    </script>
</body>
</html>
